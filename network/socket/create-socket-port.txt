âœ… When a Socket Program Opens a Socket â€” Which Port Is Used?

A socket goes through three steps:

1. socket() â€” No port yet

When you call:

int fd = socket(AF_INET, SOCK_STREAM, 0);


A file descriptor (fd) is created, but:

âŒ No IP assigned
âŒ No port assigned
âŒ Not visible in netstat or ss

It is just a file descriptor, not a network endpoint.




2. bind() â€” The program chooses a port
Case A â€” Server specifies the port

If the program calls:

struct sockaddr_in addr = {
    .sin_family = AF_INET,
    .sin_addr.s_addr = INADDR_ANY,
    .sin_port = htons(8080)
};
bind(fd, (struct sockaddr*)&addr, sizeof(addr));


Then it uses port 8080.

âœ” Explicit
âœ” Constant
âœ” Visible in ss -ltnp

Case B â€” Client does NOT specify a port

Most clients do not call bind().

Example:

connect(fd, (struct sockaddr*)&server, sizeof(server));


In this case:

ğŸ”¥ Linux auto-assigns an ephemeral port

Linux chooses a free port from:

/proc/sys/net/ipv4/ip_local_port_range


Check your system:

cat /proc/sys/net/ipv4/ip_local_port_range


Usually:

32768 60999


So client sockets use something like:

client â†’ port 34712
server â†’ port 80




3. After connect() â€” Port becomes visible

The assigned ephemeral port becomes visible:

ss -ntp


Example output:

ESTAB 0 0 192.168.1.10:34712 93.184.216.34:80 users:(("client",pid=1234))
